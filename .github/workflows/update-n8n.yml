name: Check for n8n Updates and Sync to Hugging Face Space

on:
  # schedule:
  #   - cron: '0 3 * * *'
  workflow_dispatch:

jobs:
  check-and-update:
    runs-on: ubuntu-latest
    permissions:
      # This is key: Grant this job permission to push commits to the repository
      contents: write
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          # Fetch all history to solve the "shallow update not allowed" error
          fetch-depth: 0

      - name: Get latest stable n8n version
        id: get_version
        run: |
          API_URL="https://api.github.com/repos/n8n-io/n8n/releases/latest"
          LATEST_TAG=$(curl -fsSL \
            -H "Accept: application/vnd.github+json" \
            -H "Authorization: Bearer ${{ github.token }}" \
            "$API_URL" | sed -n 's/.*"tag_name"[[:space:]]*:[[:space:]]*"\([^"]*\)".*/\1/p' | head -n1)
          LATEST_VERSION=$(echo "$LATEST_TAG" | sed -n 's/^n8n@\([0-9.]\+\)$/\1/p')

          if [ -z "$LATEST_VERSION" ]; then
            echo "::error::Failed to parse latest stable n8n version from tag: ${LATEST_TAG:-<empty>}"
            exit 1
          fi

          echo "Latest stable n8n version is: $LATEST_VERSION"
          echo "version=$LATEST_VERSION" >> "$GITHUB_OUTPUT"

      - name: Check if latest version is blacklisted
        id: check_blacklist
        run: |
          LATEST_VERSION="${{ steps.get_version.outputs.version }}"
          BLOCKLIST_FILE="version-blocklist.txt"

          if [ ! -f "$BLOCKLIST_FILE" ]; then
            echo "::warning::${BLOCKLIST_FILE} not found. No versions are blocked."
            echo "is_blacklisted=false" >> "$GITHUB_OUTPUT"
            exit 0
          fi

          IS_BLACKLISTED=false
          while IFS= read -r line || [ -n "$line" ]; do
            VERSION=$(echo "$line" | sed 's/#.*//' | xargs)
            [ -z "$VERSION" ] && continue
            if [ "$VERSION" = "$LATEST_VERSION" ]; then
              IS_BLACKLISTED=true
              break
            fi
          done < "$BLOCKLIST_FILE"

          if [ "$IS_BLACKLISTED" = "true" ]; then
            echo "Version $LATEST_VERSION is blacklisted. Skipping auto update."
            echo "is_blacklisted=true" >> "$GITHUB_OUTPUT"
          else
            echo "Version $LATEST_VERSION is allowed."
            echo "is_blacklisted=false" >> "$GITHUB_OUTPUT"
          fi

      - name: Get current version from Dockerfile
        id: get_current_version
        run: |
          CURRENT_VERSION=$(grep -oP 'n8nio/n8n:\K[0-9.]+' Dockerfile)
          echo "Current version in Dockerfile is: $CURRENT_VERSION"
          echo "version=$CURRENT_VERSION" >> $GITHUB_OUTPUT

      - name: Compare versions and update Dockerfile
        id: update_dockerfile
        if: steps.check_blacklist.outputs.is_blacklisted != 'true' && steps.get_version.outputs.version != steps.get_current_version.outputs.version && steps.get_version.outputs.version != ''
        run: |
          echo "New version found. Updating Dockerfile..."
          sed -i "s/n8nio\/n8n:${{ steps.get_current_version.outputs.version }}/n8nio\/n8n:${{ steps.get_version.outputs.version }}/g" Dockerfile
          echo "Dockerfile updated."
          echo "updated=true" >> $GITHUB_OUTPUT

      - name: Commit and push if Dockerfile was changed
        if: steps.update_dockerfile.outputs.updated == 'true'
        run: |-
          git config --global user.name 'github-actions[bot]'
          git config --global user.email 'github-actions[bot]@users.noreply.github.com'
          git add Dockerfile
          git commit -m "chore: Update n8n to version ${{ steps.get_version.outputs.version }}"
          git push

      - name: Push to Hugging Face Space
        if: steps.update_dockerfile.outputs.updated == 'true'
        env:
          HF_TOKEN: ${{ secrets.HF_TOKEN }}
          HF_REPO: ${{ vars.HF_REPO }}
        run: |-
          if [ -z "$HF_REPO" ]; then
            echo "::error::HF_REPO is not set"
            exit 1
          fi
          if ! echo "$HF_REPO" | grep -q "/"; then
            echo "::error::HF_REPO must be in owner/space format"
            exit 1
          fi
          owner=${HF_REPO%%/*}
          git remote add space "https://${owner}:${HF_TOKEN}@huggingface.co/spaces/${HF_REPO}"
          git push space main --force
          echo "Successfully synced to Hugging Face Space!"
